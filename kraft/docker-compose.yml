version: "3.8"
services:
  broker1:
    image: confluentinc/cp-kafka:7.5.0
    environment:
      - CLUSTER_ID=o3WzlxTJT6WSaewjUBkWnA
      - KAFKA_NODE_ID=1
      - KAFKA_PROCESS_ROLES=controller,broker
      - KAFKA_CONTROLLER_LISTENER_NAMES=CONTROLLER
      - KAFKA_LISTENERS=PLAINTEXT://0.0.0.0:9092,CONTROLLER://0.0.0.0:9093
      - KAFKA_ADVERTISED_LISTENERS=PLAINTEXT://broker1:9092
      - KAFKA_LISTENER_SECURITY_PROTOCOL_MAP=CONTROLLER:PLAINTEXT,PLAINTEXT:PLAINTEXT
      - KAFKA_CONTROLLER_QUORUM_VOTERS=1@broker1:9093,2@broker2:9093,3@broker3:9093
      - KAFKA_INTER_BROKER_LISTENER_NAME=PLAINTEXT

      # ULTRA-AGGRESSIVE KRaft Tuning for Sub-2s Failover
      - KAFKA_CONTROLLER_QUORUM_ELECTION_TIMEOUT_MS=500
      - KAFKA_CONTROLLER_QUORUM_FETCH_TIMEOUT_MS=500
      - KAFKA_CONTROLLER_QUORUM_REQUEST_TIMEOUT_MS=500
      - KAFKA_CONTROLLER_QUORUM_RETRY_BACKOFF_MS=50
      - KAFKA_CONTROLLER_QUORUM_ELECTION_BACKOFF_MAX_MS=500
      - KAFKA_CONTROLLER_QUORUM_LINGER_MS=10
      - KAFKA_CONTROLLER_QUORUM_HEARTBEAT_TIMEOUT_MS=300

      # Broker-side optimizations for fastest failover
      - KAFKA_REPLICA_SOCKET_TIMEOUT_MS=1000
      - KAFKA_CONTROLLER_SOCKET_TIMEOUT_MS=1000
      - KAFKA_REQUEST_TIMEOUT_MS=15000
      - KAFKA_REPLICA_FETCH_WAIT_MAX_MS=200
      - KAFKA_REPLICA_FETCH_MAX_BYTES=10485760
      - KAFKA_REPLICA_FETCH_RESPONSE_MAX_BYTES=104857600
      - KAFKA_NUM_REPLICA_FETCHERS=6

      # Critical: Faster metadata propagation
      - KAFKA_METADATA_MAX_IDLE_INTERVAL_MS=100
      - KAFKA_METADATA_MAX_RETENTION_MS=3600000

      # Network optimizations
      - KAFKA_SOCKET_CONNECTION_SETUP_TIMEOUT_MS=1000
      - KAFKA_SOCKET_CONNECTION_SETUP_TIMEOUT_MAX_MS=1000

    ports:
      - "19092:9092"
    networks:
      - kafka-net

  broker2:
    image: confluentinc/cp-kafka:7.5.0
    environment:
      - CLUSTER_ID=o3WzlxTJT6WSaewjUBkWnA
      - KAFKA_NODE_ID=2
      - KAFKA_PROCESS_ROLES=controller,broker
      - KAFKA_CONTROLLER_LISTENER_NAMES=CONTROLLER
      - KAFKA_LISTENERS=PLAINTEXT://0.0.0.0:9092,CONTROLLER://0.0.0.0:9093
      - KAFKA_ADVERTISED_LISTENERS=PLAINTEXT://broker2:9092
      - KAFKA_LISTENER_SECURITY_PROTOCOL_MAP=CONTROLLER:PLAINTEXT,PLAINTEXT:PLAINTEXT
      - KAFKA_CONTROLLER_QUORUM_VOTERS=1@broker1:9093,2@broker2:9093,3@broker3:9093
      - KAFKA_INTER_BROKER_LISTENER_NAME=PLAINTEXT

      # ULTRA-AGGRESSIVE KRaft Tuning
      - KAFKA_CONTROLLER_QUORUM_ELECTION_TIMEOUT_MS=500
      - KAFKA_CONTROLLER_QUORUM_FETCH_TIMEOUT_MS=500
      - KAFKA_CONTROLLER_QUORUM_REQUEST_TIMEOUT_MS=500
      - KAFKA_CONTROLLER_QUORUM_RETRY_BACKOFF_MS=50
      - KAFKA_CONTROLLER_QUORUM_ELECTION_BACKOFF_MAX_MS=500
      - KAFKA_CONTROLLER_QUORUM_LINGER_MS=10
      - KAFKA_CONTROLLER_QUORUM_HEARTBEAT_TIMEOUT_MS=300

      - KAFKA_REPLICA_SOCKET_TIMEOUT_MS=1000
      - KAFKA_CONTROLLER_SOCKET_TIMEOUT_MS=1000
      - KAFKA_REQUEST_TIMEOUT_MS=15000
      - KAFKA_REPLICA_FETCH_WAIT_MAX_MS=200
      - KAFKA_REPLICA_FETCH_MAX_BYTES=10485760
      - KAFKA_REPLICA_FETCH_RESPONSE_MAX_BYTES=104857600
      - KAFKA_NUM_REPLICA_FETCHERS=6
      - KAFKA_METADATA_MAX_IDLE_INTERVAL_MS=100

    ports:
      - "29092:9092"
    networks:
      - kafka-net

  broker3:
    image: confluentinc/cp-kafka:7.5.0
    environment:
      - CLUSTER_ID=o3WzlxTJT6WSaewjUBkWnA
      - KAFKA_NODE_ID=3
      - KAFKA_PROCESS_ROLES=controller,broker
      - KAFKA_CONTROLLER_LISTENER_NAMES=CONTROLLER
      - KAFKA_LISTENERS=PLAINTEXT://0.0.0.0:9092,CONTROLLER://0.0.0.0:9093
      - KAFKA_ADVERTISED_LISTENERS=PLAINTEXT://broker3:9092
      - KAFKA_LISTENER_SECURITY_PROTOCOL_MAP=CONTROLLER:PLAINTEXT,PLAINTEXT:PLAINTEXT
      - KAFKA_CONTROLLER_QUORUM_VOTERS=1@broker1:9093,2@broker2:9093,3@broker3:9093
      - KAFKA_INTER_BROKER_LISTENER_NAME=PLAINTEXT

      # ULTRA-AGGRESSIVE KRaft Tuning
      - KAFKA_CONTROLLER_QUORUM_ELECTION_TIMEOUT_MS=500
      - KAFKA_CONTROLLER_QUORUM_FETCH_TIMEOUT_MS=500
      - KAFKA_CONTROLLER_QUORUM_REQUEST_TIMEOUT_MS=500
      - KAFKA_CONTROLLER_QUORUM_RETRY_BACKOFF_MS=50
      - KAFKA_CONTROLLER_QUORUM_ELECTION_BACKOFF_MAX_MS=500
      - KAFKA_CONTROLLER_QUORUM_LINGER_MS=10
      - KAFKA_CONTROLLER_QUORUM_HEARTBEAT_TIMEOUT_MS=300

      - KAFKA_REPLICA_SOCKET_TIMEOUT_MS=1000
      - KAFKA_CONTROLLER_SOCKET_TIMEOUT_MS=1000
      - KAFKA_REQUEST_TIMEOUT_MS=15000
      - KAFKA_REPLICA_FETCH_WAIT_MAX_MS=200
      - KAFKA_REPLICA_FETCH_MAX_BYTES=10485760
      - KAFKA_REPLICA_FETCH_RESPONSE_MAX_BYTES=104857600
      - KAFKA_NUM_REPLICA_FETCHERS=6
      - KAFKA_METADATA_MAX_IDLE_INTERVAL_MS=100

    ports:
      - "39092:9092"
    networks:
      - kafka-net

networks:
  kafka-net:
    driver: bridge
